"use strict";$(function(){function e(t){var n=querystring.parse(location.search.replace("?","")),i=1*n.sn===0;if(n.sn){$(".container >.loading").hide(),$(".dragon").hide(),$(".one").hide(),$(".container").addClass("show-one");var a;a=i?"highlight.json":c+"/api/Participants/"+n.sn,$.get(a,function(t){!function(a,o){if(i){var d=$(t).filter(function(){return new Date(this.launch)<new Date&&new Date<=new Date(this.expired)});t=d[Math.floor(d.length*Math.random())]}t.number=t.number||69,t.house=t.house||l[0],t.street=t.street||r[0];var m,p=-462*(t.number/100),h=-171*(t.number/100);i?(m=t.profilePicture,s(t.families01,$(".tpl ul li:eq(0)",a),t.families01Picture,p,h),s(t.families02,$(".tpl ul li:eq(1)",a),t.families02Picture,p,h),s(t.families03,$(".tpl ul li:eq(2)",a),t.families03Picture,p,h),s(t.families04,$(".tpl ul li:eq(3)",a),t.families04Picture,p,h)):(m="https://graph.facebook.com/"+t.facebookid+"/picture?type=large",$(".tpl ul li:eq(0)",a).html(t.families01),$(".tpl ul li:eq(1)",a).html(t.families02),$(".tpl ul li:eq(2)",a).html(t.families03),$(".tpl ul li:eq(3)",a).html(t.families04)),$(".dialog span",a).html(t.words),$(".me span",a).html(t.name),$(".tpl",a).removeClass("house-home").addClass(t.house),$(".tpl .number",a).html(t.number),$(".tpl .road-name",a).html(t.street);var u=new Image;u.src=m,$(".me .dot",a).append(u),$(".me .dot",a).css("background-position",p+"px "+h+"px"),$("h1").trigger("click"),a.fadeIn(250),$(".close ",a).one("click",function(){a.hide(),$(".container").removeClass("show-one"),o.fadeIn(250,function(){window.history&&window.history.pushState?(history.pushState("home","home","./"),window.onpopstate=e):location.href="./"})}),i?($(a).prepend($("<div class='high'></div>").css("position","absolute").css("opacity","0.8").css("top",$(".tpl",a).offset().top+"px").css("left",$(".tpl",a).offset().left+"px").css("width","295px").css("height","320px").css("background","url("+t.houseBackground+") no-repeat 0 center / auto 100%")),$(".mobile").length&&($("div",$(".tpl",a).parent()).css("top","141px"),$("div",$(".tpl",a).parent()).css("left","10px")),$(".me, ul,.road-name, .road-number",a).css("color",t.color)):($(".high",a).remove(),$(".me, ul,.road-name, .road-number",a).removeAttr("style")),$(".one .button.start").on("click",function(){a.hide(),$(".build-a-home").trigger("click"),o.fadeIn(250,function(){window.history&&window.history.pushState?(history.pushState("home","home","./"),window.onpopstate=e):location.href="./"})}),$(".one .button.share").on("click",function(){var e;e=1*n.sn===0?"http://kchsu.com":c+"/iam/"+n.sn,FB.ui({method:"share",href:e})})}($(".one"),$(".dragon"))})}else $(".dragon").fadeIn(),$(".one").hide()}function t(){function e(){ga("send","event","load-counting","infinite-list","offset",d),$.get(c+"/api/Participants",{filter:{limit:5,offset:d,order:"id DESC"}},function(e){p=!1,d+=e.length,e.length<5&&(m=!1),$.each(e,function(e,t){var a=document.createElement("section");a=$(a).addClass("page house");var o=n.clone();t.number=t.number||69,t.house=t.house||l[0],t.street=t.street||r[0];var s=-462*(t.number/100),c=-171*(t.number/100);$(".me span",o).html(t.name);var d=new Image;d.src="https://graph.facebook.com/"+t.facebookid+"/picture?type=large",$(".me i",o).html(d),$(".me .dot",o).css("background-position",s+"px "+c+"px"),$(".me, ul,.road-name,.number",o).removeAttr("style"),$("ul li:eq(0)",o).html(t.families01),$("ul li:eq(1)",o).html(t.families02),$("ul li:eq(2)",o).html(t.families03),$("ul li:eq(3)",o).html(t.families04),$("ul li:eq(4)",o).html(t.families05),$(o).attr("data-serial",t.id),$(".number",o).html(t.number),$(".road-name",o).html(t.street),$(".dialog span",o).html(t.words),o.addClass(t.house),a.append(o),$(o).css("cursor","pointer").on("click",function(){location.href="./?sn="+$(this).attr("data-serial")}),a.appendTo(i)}),$(window).trigger("resize"),$(".container >.loading").hide()})}function t(e){$.get("highlight.json?_="+1*new Date,function(t){var n=$(t).filter(function(){return new Date(this.launch)<new Date&&new Date<=new Date(this.expired)}),i=n[Math.floor(n.length*Math.random())],a=$("#tpl");i.number=i.number||69,i.house=i.house||l[0],i.street=i.street||r[0],i.houseBackground=i.houseBackground||"";var o=-462*(i.number/100),c=-171*(i.number/100);$(".me span",a).html(i.name);var d=new Image;d.src=i.profilePicture,$(".me i",a).html(d),$(".me .dot",a).css("background-position",o+"px "+c+"px"),s(i.families01,$("ul li:eq(0)",a),i.families01Picture,o,c),s(i.families02,$("ul li:eq(1)",a),i.families02Picture,o,c),s(i.families03,$("ul li:eq(2)",a),i.families03Picture,o,c),s(i.families04,$("ul li:eq(3)",a),i.families04Picture,o,c),$(".number",a).html(i.number),$(".road-name",a).html(i.street),$(".dialog span",a).html(i.words),$(".me, ul,.road-name, .number",a).css("color",i.color),a.addClass(i.house),a.parent().prepend($("<div></div>").css("position","absolute").css("opacity","0.8").css("top","90px").css("left","0").css("width","295px").css("height","320px").css("background","url("+i.houseBackground+") no-repeat 0 center / auto 100%")),$(".mobile").length&&($("div",a.parent()).css("top","141px"),$("div",a.parent()).css("left","10px")),$(a).css("cursor","pointer").on("click",function(){var e=isNaN(new Date(i.timestamp))?new Date:new Date(i.timestamp);location.href="./?sn=0&timestamp="+1*e}),e()})}if(p)return!1;if(!m)return!1;var n=$("#tpl").clone().removeAttr("id"),i=$(".dragon");n.removeClass("house-home"),p=!0,$(".container >.loading").show(),0===d?t(e):e()}function n(e,t){var n=document.createElement("canvas"),i=n.getContext("2d"),a=0,o="";for(var s in e)a+=i.measureText(e[s]).width,o+=e[s],a>=t&&(o+="-<br>",a=0);return o.replace(/([\W])-/gi,"$1")}function i(e,t){function n(e,t){var n=[],i=0,a=0;for(var o in e)a++;$(e).each(function(o,s){n[o]={},n[o].target=e[o].target,n[o].image=new Image,n[o].image.onload=function(){++i>=a&&t(n)},n[o].image.src=e[o].image.src})}function i(e,t,n,i,o){a.beginPath(),a.moveTo(e+o,t),a.lineTo(e+n-o,t),a.quadraticCurveTo(e+n,t,e+n,t+o),a.lineTo(e+n,t+i-o),a.quadraticCurveTo(e+n,t+i,e+n-o,t+i),a.lineTo(e+o,t+i),a.quadraticCurveTo(e,t+i,e,t+i-o),a.lineTo(e,t+o),a.quadraticCurveTo(e,t,e+o,t),a.closePath()}var a=e.getContext("2d");a.globalAlpha=.3,n(T,function(n){$.each(n,function(e,t){var n=t.target,o=n.offset().left-$("#step3 >aside").offset().left,s=n.offset().top-$("#step3 >aside").offset().top,l=n.width(),r=n.height(),c=n.width()/2;a.save(),i(o,s,l,r,c),a.clip(),a.drawImage(t.image,o,s,l,r),a.restore()}),t(e)})}function a(e,t){$("#step3 ul li i").each(function(e,t){var n=new Image;n.src=M[1*$(t).attr("data-index")].dataUrl,T.push({image:n,target:$(t)})})}function o(){h||FB.api("/me/taggable_friends?limit=5000",function(e){$.each(e.data,function(e,t){M.push({name:t.name,url:t.picture.data.url,pattern:1*new Date,launch:JSON.stringify(new Date).replace(/\"/gi,""),expired:"2015-12-31T16:00:00.000Z",facebookId:null,value:t.name.length<=10?t.name:t.name.replace(/^(\S+).*/i,"$1")})});var t=function(){return function(e,t){var n;n=[],$.each(M,function(t,i){var a=new RegExp(e.replace(/\s/gi,".*|"),"ig");a.test(i.name)&&(i.index=t,n.push(i))}),t(n)}};$("[name=families01],[name=families02],[name=families03],[name=families04]").typeahead(null,{name:"best-pictures",display:"value",source:t(),templates:{empty:['<div class="empty-message">',"...","</div>"].join("\n"),suggestion:function(e){return"<div><span>"+e.name+"</span> <img src='"+e.url+"'></div>"}}}).bind("typeahead:selected",function(e,t,n){var i=$(this).parents("#step2,#step3 aside"),a=$(this),o=document.createElement("i");$(o).addClass("celebrities").attr("data-target",this.name).attr("data-index",t.index);var s=new Image;$(o).append(s),TweenMax.set(o,{left:a.offset().left+1*a.css("margin-left").replace(/px/,"")-i.offset().left+21,top:a.offset().top-i.offset().top+a.height()+1}),s.onload=function(){$("i.celebrities[data-target="+a.attr("name")+"]",i).remove(),$(i).append(o),a.val(t.value),t.dataUrl||$.post(c+"/imgData",{imgUrl:t.url}).done(function(e){e=$.parseJSON(e),M[t.index].dataUrl=e.dataUrl})},s.src=t.url}),h=!0})}function s(e,t,n,i,a){if(t.html(e),n){var o=new Image;o.onload=function(){t.append($("<i class='celebrities'></i>").html(o)),$("i",t).css("background-position",i+"px "+a+"px")},o.src=n}}var l=["house-home","house-happiness","house-equality","house-plurality"],r=["光譜一街","光譜二街","光譜三街","平等一路","平等二路","平等三路","和諧街","陽光大道","石牆路","伴侶南路","伴侶北路","平權東路","平權西路","擇愛一路","擇愛二路","擇愛三路","擇愛四路","擇愛五路","成家一路","成家二路","成家三路","成家四路","成家五路","家屬南路","家屬北路","家屬東路","家屬西路","羈絆路","偕老一路","偕老二路"],c="http://api.kchsu.com",d=0,m=!0,p=!1,h=!1,u=function(e,t){t=t||function(){},$.colorbox({inline:!0,href:e,transition:"fade",innerWidth:600,initialWidth:"100%",initialHeight:"100%",title:"",overlayClose:!1,escKey:!1,onComplete:t})},f=function(){ga("send","event","colorbox","colorbox","close",1),d=0,$(window).trigger("resize"),$.colorbox.close()};if(e(),$.get(c+"/api/Participants/count",function(e){$(".party-count").html(e.count)}),$("html.desktop,html.tablet").length){if(function(e){$(e).on("scroll resize",function(){var t=$(e).width(),n=$(e).height()>530?$(e).height():530;$("body").width(t),$("body").height(n),$(".home").width(t)}).trigger("resize")}(window),$(".text-muted a").on("click",function(){return $("html.desktop").length&&TweenMax.to($(".dragon"),.3,{left:60,onComplete:function(){$(window).trigger("mousewheel")}}),$("html.tablet").length&&TweenMax.to($(window),.3,{scrollLeft:-20}),!1}),$("html.desktop").length||$("html.ie11").length){$(".dragon:not(.one),.cross").on("mousewheel",function(e){var n=0,i=$(".dragon"),a=$(".page.home").width()+1+625+($(".page.house").width()+2)*$(".page.house").length;$(".dragon").width(a);var o=$(".dragon").width(),s=$(window).width()-o;if(e.deltaY<0?n=-1:e.deltaY>0&&(n=1),+i.css("left").replace(/px/,"")>=0&&n>=0)return TweenMax.to(i,.25,{left:0}),!1;if(+i.css("left").replace(/px/,"")<=s&&0>=n)return TweenMax.to(i,.25,{left:s+"px"}),t(),!1;var l=12e3/$(window).width();$("html.mac").length>0&&(l=300/$(window).width());var r=+$(".cross").attr("data-zfact"),c=+$(".road").attr("data-zfact");return TweenMax.to(i,.3,{left:"+="+e.deltaY*l+"%"}),TweenMax.to($(".cross"),.3,{left:"+="+e.deltaY*l/r+"%"}),TweenMax.to($(".road"),.3,{left:"+="+e.deltaY*l/c+"%"}),!1});var g,w,v;new Draggabilly(".dragon",{axis:"x"}).on("dragStart",function(e){g=e.clientX}).on("pointerUp",function(e){w=e.clientX;var t=g-w,n=$(".dragon");try{v.kill()}catch(e){}v=TweenMax.to(n,1,{left:"-="+t/2,onComplete:function(){$(".dragon").trigger("mousewheel")}})})}if($("html.tablet").length&&!$("html.ie11").length){var b=0;$(window).on("scroll resize",function(){var e=0,n=($(".dragon"),$(".page.home").width()+1+625+($(".page.house").width()+2)*$(".page.house").length);$(".container, .dragon").width(n);var i=$(".dragon").width();$(window).width()-i;$(window).scrollLeft()<b?e=-1:$(window).scrollLeft()>b&&(e=1),b=$(window).scrollLeft(),1===e&&$(window).scrollLeft()>=$(".container").width()-1.5*$(window).width()&&t()}).trigger("resize")}$(".goto-rule").on("click",function(){var e=$(".dragon");$("html.desktop").length||$("html.ie11").length?TweenMax.to(e,.3,{left:$(window).width()*-.8,onComplete:function(){$(window).trigger("resize")}}):(e=$("html,body"),TweenMax.to(e,.3,{scrollLeft:.8*$(window).width(),onComplete:function(){$(window).trigger("resize")}}))}),$(window).trigger("resize")}$("html.mobile").length&&(!function(e){var n=0;$(e).on("scroll resize",function(){var i=$(e).width(),a=$(e).height()>530?$(e).height():530;$("body").width(i),$(".home").width(i),$(".pageSizeHeight").length||$("<style></style>").addClass("pageSizeHeight").appendTo($("head")),$(".pageSizeHeight").html(".home{height:"+a+"px!important}");var o=0;$(window).scrollTop()<n?o=-1:$(window).scrollTop()>n&&(o=1),n=$(window).scrollTop();var s=querystring.parse(location.search.replace("?",""));s.sn||1===o&&$(window).scrollTop()>=$("body").height()-1.5*$(window).height()&&t()}).trigger("resize")}(window),function(e){$(".menu",e).on("click",function(){ga("send","event","menu","menu","slide",1),$(".nav-pills",e).toggleClass("on"),$(".container").one("click",function(){$(".nav-pills",e).removeClass("on")})}),u=function(e,t){t=t||function(){},TweenMax.set($(e),{overflow:"auto",height:"auto"}),TweenMax.set($(e).siblings(),{overflow:"hidden",height:$(window).height()}),TweenMax.set($("body >.container .dragon"),{display:"none"}),TweenMax.set($("body >.container"),{position:"absolute",height:"100%"}),TweenMax.set($(".box"),{width:"100%"}),TweenMax.to($(e),.2,{width:"100%",display:"block"}),TweenMax.to($(e).siblings(),.2,{width:0,display:"none"}),TweenMax.to($("html,body"),.2,{scrollTop:0,delay:.2,onComplete:t}),p=!0},f=function(){ga("send","event","colorbox","colorbox","close",1),TweenMax.set($(".box"),{width:0}),TweenMax.set($("body >.container .dragon"),{opacity:0,display:"block"}),TweenMax.set($("body >.container"),{position:"static",height:"auto"}),TweenMax.to($("body >.container .dragon"),.2,{opacity:1}),p=!1},$(".goto-rule",e).on("click",function(){TweenMax.to($("html,body"),.25,{scrollTop:$(".go").offset().top-100})})}($("html.mobile")));var x,y={},k=!1,T=[],M=[];$(".go .term").on("click",function(){ga("send","event","terms","terms","click",1),u("#terms")}),$(".nav-pills li:eq(0)").on("click",function(){$(".nav-pills").removeClass("on"),u("#about")}),$("#step2 .add-button").on("click",function(){ga("send","event","participants-steps","add-family","click",1),$("#step2 .families.tt-input.hide:eq(0)").fadeTo(1,0).removeClass("hide").fadeTo(200,1),$("#step2 .families.hide:eq(0)").length||$(this).fadeOut(250)}),$(".build-a-home").on("click touchend",function(){function e(){u($("#step2"))}ga("send","event","participants-steps","facebook-login","start",1),FB.login(function(t){return"connected"===t.status?void FB.api("/me?fields=email,name,first_name",function(t){y.name=t.first_name,y.email=t.email,y.facebookid=t.id,y.timestamp=1*new Date,$.get(c+"/face/"+y.facebookid,function(e){var n=new Image;n.src="https://graph.facebook.com/"+t.id+"/picture?type=large",$("#step3 .me .dot").html(n);var i=new Image;i.src=e.dataUrl,T.push({image:i,target:$("#step3 .me img")})}),$("#step2 .families,#step2 [name=words]").val(""),$("#step2 .celebrities").remove(),o(),e()}):void 0},{scope:"email,user_friends"}),ga("send","event","participants-steps","facebook-login","denied",1)}),$("#step2 .submit").on("click",function(){if(ga("send","event","participants-steps","create-house","submit",1),k)return!1;k=!0;var e=l[Math.floor(Math.random()*+new Date%l.length)],o=r[Math.floor(Math.random()*+new Date%r.length)];y.words=n($("#step2 [name=words]").val(),160),y.street=n(o,10),y.number=Math.floor(Math.random()*+new Date%99);var s=-462*(y.number/100),m=-171*(y.number/100),p=$(document.createElement("i"));p.html($("#step2 [data-target=families01]").clone().removeAttr("style").css("background-position",s+"px "+m+"px")),y.families01=$("#step2 [name=families01]").val()+p.html(),p.html($("#step2 [data-target=families02]").clone().removeAttr("style").css("background-position",s+"px "+m+"px")),y.families02=$("#step2 [name=families02]").val()+p.html(),p.html($("#step2 [data-target=families03]").clone().removeAttr("style").css("background-position",s+"px "+m+"px")),y.families03=$("#step2 [name=families03]").val()+p.html(),p.html($("#step2 [data-target=families04]").clone().removeAttr("style").css("background-position",s+"px "+m+"px")),y.families04=$("#step2 [name=families04]").val()+p.html(),a(),y.house=e,$("#step3 .name,#step3 .me span").html(y.name),$("#step3 ul li:eq(0)").html(y.families01),$("#step3 ul li:eq(1)").html(y.families02),$("#step3 ul li:eq(2)").html(y.families03),$("#step3 ul li:eq(3)").html(y.families04),$("#step3 .dialog span").html(y.words),$("#step3 .number").html(y.number),$("#step3 .road-name").html(y.street),$("#step3 .me .dot").css("background-position",s+"px "+m+"px"),$("#step3 .tpl").removeClass("house-home").addClass(e),$("#step4 [name=email]").attr("placeholder",y.email),$.post(c+"/api/Participants",y,function(e){$(".dragon >.page.house").remove(),d=0,t(),x=e.id,$("#step3 .button").hide(),u("#step3",function(){html2canvas($("#step3 >aside"),{onrendered:function(e){a(),i(e,function(e){var t=e.toDataURL("image/png"),n=document.createElement("img");n.src=t,TweenMax.set(n,{position:"absolute",left:0,top:0,display:"none"}),$.ajax({method:"POST",data:{base64Url:$(n).attr("src")},url:c+"/api/Participants/s/"+x}).done(function(){$("#step3 .button").fadeIn(),k=!1}).error(function(e,t){alert("圖片無法上傳")}),$(n).appendTo($("#step3"))})}})})})}),$("#step3 .button").on("click",function(){ga("send","event","participants-steps","share","share-loaded",1);var e=c+"/iam/"+x;FB.ui({method:"share",href:e},function(e){e&&!e.error_code&&(ga("send","event","participants-steps","share","share-complete",1),u("#step4"))})}),$("#step4 .button.submit").on("click",function(){ga("send","event","participants-steps","submit-user-info","submit",1),y.email=$("#step4 [name=email]").val()||y.email,y.officialName=$("#step4 [name=name]").val(),y.address=$("#step4 [name=address]").val(),$.ajax({method:"POST",headers:{Accept:"application/json"},data:JSON.stringify(y),contentType:"application/json; charset=UTF-8",url:c+"/api/Participants/?where="+JSON.stringify({id:x})}).done(function(e){f()})}),t(),$.getJSON("celebrities.json?_="+1*new Date,function(e){M=$(e.celebrities).filter(function(){return new Date(this.launch)<new Date&&new Date<new Date(this.expired)})})}),window.fbAsyncInit=function(){var e=/localhost/.test(location.href)?"1649099138703605":"1645980782348774";FB.init({appId:e,xfbml:!0,version:"v2.4"})},function(e,t,n){var i,a=e.getElementsByTagName(t)[0];e.getElementById(n)||(i=e.createElement(t),i.id=n,i.src="//connect.facebook.net/zh_TW/all.js",a.parentNode.insertBefore(i,a))}(document,"script","facebook-jssdk"),function(e,t,n,i,a,o){e.GoogleAnalyticsObject=i,e[i]||(e[i]=function(){(e[i].q=e[i].q||[]).push(arguments)}),e[i].l=+new Date,a=t.createElement(n),o=t.getElementsByTagName(n)[0],a.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(a,o)}(window,document,"script","ga"),ga("create","UA-50961568-3"),ga("send","pageview");